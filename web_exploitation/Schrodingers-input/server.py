import os
import time
import asyncio
import random
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse, JSONResponse
import aiofiles

FLAG = os.getenv("FLAG", "DSCCTF{dev_flag_change_me_2026}")

app = FastAPI()

LOG_FILE = "player_behavior.log"


# async logging so attackers can't DoS disk writes
async def log_event(ip, payload, response_time):
    async with aiofiles.open(LOG_FILE, "a") as f:
        await f.write(f"{time.time()} | {ip} | {payload} | {response_time}\n")


def jitter():
    """
    Small random delay to defeat naive timing attacks
    but not strong enough to stop statistical attacks.
    """
    time.sleep(random.uniform(0.005, 0.02))


def insecure_compare(user_input, real_flag):
    """
    Timing leak with jitter.
    Sleeps slightly for each correct character.
    """

    if len(user_input) > len(real_flag):
        jitter()
        return False

    for i in range(len(user_input)):

        if user_input[i] != real_flag[i]:
            jitter()
            return False

        # deterministic leak
        time.sleep(0.028)

        # noise
        jitter()

    return user_input == real_flag


@app.get("/", response_class=HTMLResponse)
async def home():
    return """
    <html>
        <head>
            <title>Quantum Validation Portal</title>
        </head>

        <body style="background:#0e1116;color:#e6edf3;font-family:monospace;text-align:center;margin-top:120px;">
            <h2>Quantum Validation Portal</h2>
            <p>Observation changes the outcome.</p>

            <input id='flag' style="padding:10px;width:350px;background:#161b22;border:1px solid #30363d;color:white;"/>
            <br><br>
            <button onclick='send()' style="padding:10px 20px;">Validate</button>

            <script>
            async function send(){
                let val = document.getElementById("flag").value;

                let res = await fetch("/validate", {
                    method:"POST",
                    headers:{"Content-Type":"application/json"},
                    body:JSON.stringify({flag:val})
                });

                let data = await res.json();
                alert(data.msg);
            }
            </script>
        </body>
    </html>
    """


@app.post("/validate")
async def validate(req: Request):
    data = await req.json()
    user_flag = data.get("flag","")

    ip = req.client.host

    start = time.perf_counter()
    result = insecure_compare(user_flag, FLAG)
    elapsed = round(time.perf_counter() - start, 4)

    asyncio.create_task(log_event(ip, user_flag, elapsed))

    if result:
        return {"msg":"Correct. The waveform collapses."}

    return JSONResponse({
        "msg":"Incorrect.",
        "response_time": elapsed
    })
