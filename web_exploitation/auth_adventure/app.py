from flask import Flask, request, jsonify, render_template_string, redirect, url_for
import jwt
import datetime
import secrets

app = Flask(__name__)

# Weak secret key (vulnerability)
SECRET_KEY = "secret123"

# Admin credentials (hardcoded for simplicity) 
ADMIN_USERNAME = "admin"
ADMIN_PASSWORD = "super_secret_admin_password_2026"

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html>
<head>
    <title>Auth Adventure</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 5px; margin: 20px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="text"], input[type="password"] { width: 200px; padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîê Auth Adventure Challenge</h1>
    
    {% if current_user %}
        <div class="container success">
            <h2>Welcome, {{ current_user.username }}!</h2>
            <p><strong>Role:</strong> {{ current_user.role }}</p>
            <p><strong>User ID:</strong> {{ current_user.user_id }}</p>
            
            {% if current_user.role == 'admin' %}
                <div class="container success">
                    <h3>üéâ Admin Access Granted!</h3>
                    <p><strong>Flag:</strong> DSCCTF{JWT_SECRET_CRACKED_2026}</p>
                </div>
            {% else %}
                <div class="container info">
                    <h3>User Dashboard</h3>
                    <p>You have regular user access. To get the flag, you need admin privileges!</p>
                    <p><strong>Hint:</strong> The JWT token might not be as secure as it seems...</p>
                </div>
            {% endif %}
            
            <p><strong>Your JWT Token:</strong></p>
            <textarea readonly style="width: 100%; height: 100px;">{{ token }}</textarea>
            
            <br><br>
            <a href="/logout"><button>Logout</button></a>
        </div>
    {% else %}
        <div class="container">
            <h2>Login</h2>
            <form method="POST" action="/login">
                <p>
                    <label>Username:</label><br>
                    <input type="text" name="username" placeholder="Enter username" required>
                </p>
                <p>
                    <label>Password:</label><br>
                    <input type="password" name="password" placeholder="Enter password" required>
                </p>
                <button type="submit">Login</button>
            </form>
            
            <div class="container info">
                <h3>Test Credentials</h3>
                <p><strong>Username:</strong> user<br>
                <strong>Password:</strong> password123</p>
                <p>Can you escalate to admin privileges? ü§î</p>
            </div>
        </div>
    {% endif %}
    
    <div class="container">
        <h3>Challenge Info</h3>
        <p>This application uses JWT tokens for authentication. Your goal is to gain admin access to retrieve the flag.</p>
        <p><strong>Hint:</strong> JWTs can sometimes be manipulated if the secret is weak...</p>
    </div>
</body>
</html>
'''

@app.route('/')
def index():
    token = request.cookies.get('token')
    current_user = None
    
    if token:
        try:
            # Vulnerable: using weak secret
            payload = jwt.decode(token, SECRET_KEY, algorithms=['HS256'])
            current_user = {
                'username': payload['username'],
                'role': payload['role'],
                'user_id': payload['user_id']
            }
        except jwt.InvalidTokenError:
            pass
    
    return render_template_string(HTML_TEMPLATE, current_user=current_user, token=token)

@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']
    password = request.form['password']
    
    # Simple user validation
    if username == "user" and password == "password123":
        # Create JWT token
        payload = {
            'username': username,
            'role': 'user',  # Not admin!
            'user_id': 1001,
            'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)
        }
        
        token = jwt.encode(payload, SECRET_KEY, algorithm='HS256')
        
        response = redirect(url_for('index'))
        response.set_cookie('token', token)
        return response
    
    elif username == ADMIN_USERNAME and password == ADMIN_PASSWORD:
        # Admin login (very unlikely to be guessed)
        payload = {
            'username': username,
            'role': 'admin',
            'user_id': 1,
            'exp': datetime.datetime.utcnow() + datetime.timedelta(hours=24)
        }
        
        token = jwt.encode(payload, SECRET_KEY, algorithm='HS256')
        
        response = redirect(url_for('index'))
        response.set_cookie('token', token)
        return response
    
    else:
        return "Invalid credentials!", 401

@app.route('/logout')
def logout():
    response = redirect(url_for('index'))
    response.set_cookie('token', '', expires=0)
    return response

@app.route('/hint')
def hint():
    return jsonify({
        "hint": "The JWT secret might be weaker than you think. Try common passwords or brute force!",
        "algorithm": "HS256",
        "additional_hint": "Check jwt.io for decoding and manipulation tools"
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8003, debug=False)