from fastapi import FastAPI, Form, Request
from fastapi.responses import HTMLResponse

app = FastAPI()

REAL_PASSWORD = "clockwork"
XOR_KEY = "TIME"

ENCRYPTED_FLAG = "LQkXGxQMFw0IG1cMHB4dBhsfBg8OFlk="
PASSWORD_COOKIE = "636c6f636b776f726b"  # hex for "clockwork"


@app.get("/", response_class=HTMLResponse)
def index(request: Request):
    html = """
    <h2>Login</h2>
    <form method="post" action="/login">
        <input type="password" name="password" placeholder="Password">
        <button type="submit">Login</button>
    </form>
    """

    response = HTMLResponse(html)

    # Set cookie silently if not present
    if "auth_hint" not in request.cookies:
        response.set_cookie(
            key="auth_hint",
            value=PASSWORD_COOKIE,
            httponly=False
        )

    return response


@app.post("/login", response_class=HTMLResponse)
def login(password: str = Form(...)):
    if password == REAL_PASSWORD:
        return """
        <h3>Authentication successful</h3>
        <p>Knowing is not enough.</p>
        <p><b>Key:</b> TIME</p>
        """

    return f"""
    <h3>Authentication failed</h3>
    <p>You were never supposed to succeed here.</p>
    <p>Encrypted data:</p>
    <pre>{ENCRYPTED_FLAG}</pre>
    """
