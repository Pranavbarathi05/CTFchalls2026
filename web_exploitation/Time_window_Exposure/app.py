from fastapi import FastAPI
from fastapi.responses import JSONResponse, HTMLResponse
import time

app = FastAPI()

REAL_FLAG = "DSCCTF{m1ll1s3c0nd_m4tt3rs_w3b_2026}"
FAKE_FLAG = "DSCCTF{wrong_flag_try_harder}"

INDEX_PAGE = """
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Time Gate</title>
<style>
body {
    margin: 0;
    height: 100vh;
    background: radial-gradient(circle at center, #0a0a0a, #000);
    color: #e6e6e6;
    font-family: 'Arial', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
}

.panel {
    text-align: center;
    padding: 40px 50px;
    border: 1px solid #222;
    box-shadow: 0 0 40px rgba(0,255,255,0.05);
    background: rgba(0,0,0,0.6);
}

h1 {
    letter-spacing: 3px;
    margin-bottom: 10px;
}

.subtitle {
    opacity: 0.6;
    margin-bottom: 30px;
}

button {
    padding: 12px 28px;
    font-size: 16px;
    cursor: pointer;
    background: none;
    border: 1px solid #0ff;
    color: #0ff;
    letter-spacing: 2px;
    transition: all 0.2s ease;
}

button:hover {
    background: #0ff;
    color: #000;
}

#output {
    margin-top: 25px;
    font-size: 14px;
    min-height: 1.2em;
    opacity: 0.9;
}

.timer {
    margin-top: 15px;
    font-size: 12px;
    opacity: 0.4;
}
</style>
</head>
<body>
<div class="panel">
    <h1>TIME GATE</h1>
    <div class="subtitle">Precision is everything.</div>
    <button onclick="requestFlag()">REQUEST ACCESS</button>
    <div id="output"></div>
    <div class="timer" id="timer"></div>
</div>

<script>
function requestFlag() {
    document.getElementById("output").innerText = "Synchronizing...";
    fetch("/flag")
        .then(r => r.json())
        .then(d => {
            document.getElementById("output").innerText = d.flag;
        })
        .catch(() => {
            document.getElementById("output").innerText = "Connection error.";
        });
}

setInterval(() => {
    const now = new Date();
    document.getElementById("timer").innerText =
        "Local Time: " + now.toISOString().slice(11,23);
}, 50);
</script>
</body>
</html>
"""

@app.get("/", response_class=HTMLResponse)
def index():
    return INDEX_PAGE


@app.get("/flag")
def flag():
    current_ms = int(time.time() * 1000)
    window = current_ms % 60000

    if window < 100:
        return JSONResponse({"flag": REAL_FLAG})
    else:
        return JSONResponse({"flag": FAKE_FLAG})
