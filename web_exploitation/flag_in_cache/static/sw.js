const CACHE_NAME = "archive-v1";

self.addEventListener("install", (event) => {
  self.skipWaiting();
});

self.addEventListener("activate", (event) => {
  event.waitUntil(self.clients.claim());
});

self.addEventListener("fetch", (event) => {
  if (event.request.url.includes("/api/flag")) {
    event.respondWith(
      caches.open(CACHE_NAME).then(async (cache) => {
        // If cached, return cached version
        const cached = await cache.match(event.request);
        if (cached) {
          return cached;
        }

        // Otherwise cache a fake old response
        const fakeResponse = new Response(
          JSON.stringify({
            cached: "RFNDQ1RGe3RoM19icjB3czNyX24zdjNyX2YwcmczdHNfMjAyNn0=",
          }),
          { headers: { "Content-Type": "application/json" } },
        );

        cache.put(event.request, fakeResponse.clone());
        return fakeResponse;
      }),
    );
    return;
  }

  // Default behavior
  event.respondWith(fetch(event.request));
});
