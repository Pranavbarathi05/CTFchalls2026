FROM ubuntu:20.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    make \
    libc6-dev \
    socat \
    && rm -rf /var/lib/apt/lists/*

# Create challenge user
RUN useradd -m -s /bin/bash ctf

# Copy challenge files
COPY menu_pwner.c /home/ctf/
COPY Makefile /home/ctf/
COPY flag.txt /home/ctf/
COPY start.sh /home/ctf/

# Set working directory
WORKDIR /home/ctf

# Compile the challenge
RUN make clean && make

# Set permissions
RUN chmod +x start.sh
RUN chmod 444 flag.txt
RUN chown -R root:ctf /home/ctf
RUN chmod 755 /home/ctf
RUN chmod 755 menu_pwner

# Switch to ctf user
USER ctf

# Expose port
EXPOSE 9999

# Run the challenge
CMD ["./start.sh"]