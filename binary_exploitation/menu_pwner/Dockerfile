# Build stage
FROM ubuntu:20.04 AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    make \
    libc6-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy source files
COPY menu_pwner.c /build/
COPY Makefile /build/

WORKDIR /build

# Compile the challenge
RUN make clean && make

# Runtime stage
FROM ubuntu:20.04

# Install only runtime dependencies
RUN apt-get update && apt-get install -y \
    socat \
    && rm -rf /var/lib/apt/lists/*

# Create challenge user
RUN useradd -m -s /bin/bash ctf

# Copy compiled binary from builder stage
COPY --from=builder /build/menu_pwner /home/ctf/
COPY flag.txt /home/ctf/
COPY start.sh /home/ctf/

# Set permissions
RUN chmod +x /home/ctf/start.sh
RUN chmod 444 /home/ctf/flag.txt
RUN chown -R root:ctf /home/ctf
RUN chmod 755 /home/ctf
RUN chmod 755 /home/ctf/menu_pwner

# Switch to ctf user
USER ctf
WORKDIR /home/ctf

# Expose port
EXPOSE 9999

# Run the challenge
CMD ["./start.sh"]