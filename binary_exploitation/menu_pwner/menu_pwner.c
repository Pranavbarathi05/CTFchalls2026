#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

#define MAX_NOTES 10
#define MAX_SIZE 256

typedef struct Note {
    char *content;
    size_t size;
    int active;
    void (*printer)(struct Note *);
} Note;

Note notes[MAX_NOTES];
int note_count = 0;
int admin_mode = 0;
int debug_enabled = 0;

/* ================= Utility ================= */

void banner() {
    printf("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n");
    printf("â•‘           MENU PWNER v2.0            â•‘\n");
    printf("â•‘         Tiny Note Manager            â•‘\n");
    printf("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n");
}

void print_menu() {
    printf("\n=== MENU ===\n");
    printf("1. Add note\n");
    printf("2. Edit note\n");
    printf("3. Delete note\n");
    printf("4. View note\n");
    printf("5. List notes\n");
    if (debug_enabled) printf("6. Debug stats\n");
    if (admin_mode) printf("7. Admin panel\n");
    printf("0. Exit\n");
    printf("Choice: ");
}

int get_int() {
    char buf[16];
    if (!fgets(buf, sizeof(buf), stdin)) return -1;
    return atoi(buf);
}

void get_string(char *buf, size_t size) {
    if (fgets(buf, size, stdin))
        buf[strcspn(buf, "\n")] = 0;
}

/* ================= Admin ================= */

void trigger_admin(Note *n) {
    printf("[!] Admin mode activated!\n");
    admin_mode = 1;
}

void admin_panel() {
    if (!admin_mode) {
        printf("[-] Access denied! Admin mode required.\n");
        return;
    }

    printf("\nðŸŽ‰ ADMIN ACCESS GRANTED! ðŸŽ‰\n");

    FILE *fp = fopen("flag.txt", "r");
    if (fp) {
        char flag[256];
        fgets(flag, sizeof(flag), fp);
        printf("Flag: %s\n", flag);
        fclose(fp);
    } else {
        printf("Flag: DSCCTF{heap_master_fixed_2026}\n");
    }
}

/* ================= Note Printer ================= */

void normal_print(Note *n) {
    printf("Note: %s\n", n->content);
}

/* ================= Core Functions ================= */

void add_note() {
    if (note_count >= MAX_NOTES) {
        printf("[-] Max notes reached\n");
        return;
    }

    printf("Note size (max %d): ", MAX_SIZE);
    int size = get_int();

    if (size <= 0 || size > MAX_SIZE) {
        printf("[-] Invalid size\n");
        return;
    }

    int idx = -1;
    for (int i = 0; i < MAX_NOTES; i++)
        if (!notes[i].active) { idx = i; break; }

    if (idx == -1) return;

    notes[idx].content = malloc(size);
    notes[idx].size = size;
    notes[idx].active = 1;
    notes[idx].printer = normal_print;
    note_count++;

    printf("Note content: ");
    get_string(notes[idx].content, size);

    printf("[+] Note %d created\n", idx);
}

void edit_note() {
    printf("Note index: ");
    int idx = get_int();

    if (idx < 0 || idx >= MAX_NOTES || !notes[idx].active) {
        printf("[-] Invalid index\n");
        return;
    }

    printf("New content: ");
    get_string(notes[idx].content, notes[idx].size);
}

void delete_note() {
    printf("Note index: ");
    int idx = get_int();

    if (idx < 0 || idx >= MAX_NOTES || !notes[idx].active)
        return;

    /* UAF bug: printer pointer NOT cleared */
    free(notes[idx].content);
    notes[idx].active = 0;
    note_count--;

    printf("[+] Note deleted\n");
}

void view_note() {
    printf("Note index: ");
    int idx = get_int();

    if (idx < 0 || idx >= MAX_NOTES || !notes[idx].active) {
        printf("[-] Invalid index\n");
        return;
    }

    notes[idx].printer(&notes[idx]);
}

void list_notes() {
    for (int i = 0; i < MAX_NOTES; i++)
        if (notes[i].active)
            printf("[%d] size=%zu\n", i, notes[i].size);
}

void debug_stats() {
    if (!debug_enabled) return;

    printf("\n=== DEBUG ===\n");
    printf("Admin: %d\n", admin_mode);

    for (int i = 0; i < MAX_NOTES; i++)
        if (notes[i].active)
            printf("[%d] ptr=%p printer=%p\n",
                i,
                notes[i].content,
                notes[i].printer);
}

/* ================= Setup ================= */

void setup() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);
    debug_enabled = 1;
}

/* ================= Main ================= */

int main() {
    setup();
    banner();

    while (1) {
        print_menu();
        int c = get_int();

        switch (c) {
            case 1: add_note(); break;
            case 2: edit_note(); break;
            case 3: delete_note(); break;
            case 4: view_note(); break;
            case 5: list_notes(); break;
            case 6: debug_stats(); break;
            case 7: admin_panel(); break;
            case 0: exit(0);
            default: puts("Invalid");
        }
    }
}
